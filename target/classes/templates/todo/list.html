<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ToDo 一覧</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h4 mb-0">ToDo 一覧</h1>
        <a class="btn btn-primary" th:href="@{/todos/new}">新規作成</a>
    </div>

    <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert" th:text="${error}"></div>

    <div th:if="${#lists.isEmpty(todos)}" class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="display-6 mb-3">ToDoがまだ登録されていません</div>
            <p class="text-muted mb-4">まずは1件、ToDoを作成してみましょう。</p>
            <a class="btn btn-primary" th:href="@{/todos/new}">新規作成へ進む</a>
        </div>
    </div>

    <div th:unless="${#lists.isEmpty(todos)}" class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th>タイトル</th>
                <th>期限日</th>
                <th>優先度</th>
                <th>完了</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="todo : ${todos}">
                <td th:text="${todo.title}"
                    th:classappend="${todo.completed} ? 'text-decoration-line-through text-muted' : ''"></td>
                <td th:text="${todo.dueDate != null ? #temporals.format(todo.dueDate, 'yyyy/MM/dd') : '-'}"
                    th:classappend="${todo.dueDate != null and todo.dueDate.isBefore(T(java.time.LocalDate).now())} ? 'text-danger' : ''"></td>
                <td>
                    <span th:if="${todo.priority != null}" th:text="${'★'.repeat(todo.priority)}"></span>
                    <span th:if="${todo.priority == null}">-</span>
                </td>
                <td>
                    <form class="toggle-form d-flex align-items-center gap-2"
                          th:action="@{/todos/{id}/toggle(id=${todo.id})}" method="post">
                        <div class="form-check mb-0">
                            <input class="form-check-input js-toggle" type="checkbox"
                                   th:checked="${todo.completed}" th:data-id="${todo.id}">
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-secondary">切替</button>
                    </form>
                </td>
                <td class="d-flex gap-2">
                    <a class="btn btn-sm btn-outline-primary" th:href="@{/todos/{id}(id=${todo.id})}">詳細</a>
                    <a class="btn btn-sm btn-outline-secondary" th:href="@{/todos/{id}/edit(id=${todo.id})}">編集</a>
                    <form th:action="@{/todos/{id}/delete(id=${todo.id})}" method="post"
                          onsubmit="return confirm('本当に削除しますか？')">
                        <button type="submit" class="btn btn-sm btn-outline-danger">削除</button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    setTimeout(function () {
        var alerts = document.querySelectorAll('.alert');
        alerts.forEach(function (alert) {
            alert.classList.remove('show');
            alert.classList.add('hide');
        });
    }, 3000);
</script>
<script>
    document.querySelectorAll('.toggle-form').forEach(function (form) {
        var checkbox = form.querySelector('.js-toggle');
        if (!checkbox) {
            return;
        }
        checkbox.addEventListener('change', function (e) {
            var original = !checkbox.checked;
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }).then(function (res) {
                if (!res.ok) {
                    throw new Error('toggle failed');
                }
                return res.json();
            }).then(function (data) {
                var row = form.closest('tr');
                if (!row) {
                    return;
                }
                var titleCell = row.querySelector('td');
                if (titleCell) {
                    if (data.completed) {
                        titleCell.classList.add('text-decoration-line-through', 'text-muted');
                    } else {
                        titleCell.classList.remove('text-decoration-line-through', 'text-muted');
                    }
                }
            }).catch(function () {
                checkbox.checked = original;
                alert('完了状態の更新に失敗しました');
            });
        });
    });
</script>
</body>
</html>
